# 고수준 작업 계획 (High-Level Plan)

## 작업 접근 방법

### 1단계: 정보 수집

**수집할 정보**:
- `PreviewCanvasComponent.tsx`의 현재 드래그 구현 방식 (마우스 이벤트 핸들러)
- 현재 드래그 핸들의 렌더링 방식 및 위치 계산 로직
- 텍스트 렌더링 위치 정보 (settings.left, settings.top, fontSize)
- 이미지 스케일링 로직 (imageScale 계산 방식)

**수집 방법**:
- `PreviewCanvasComponent.tsx` 파일의 현재 구현 코드 분석
- 드래그 이벤트 핸들러 (`handleMouseDown`, `handleMouseMove`, `handleMouseUp`) 검토
- 드래그 핸들 렌더링 부분 (144-180번 줄) 검토

**예상 결과물**:
- 현재 드래그 시스템의 구조 파악 (마우스 이벤트 기반)
- 좌표 변환 로직 이해 (display 좌표 → 실제 이미지 좌표)
- 드래그 핸들 위치 계산 방식 이해

### 2단계: 분석

**분석 대상**:
- 아웃라인 박스 렌더링을 위한 텍스트 영역 계산 방법
- 터치 이벤트 미지원의 원인 (현재 마우스 이벤트만 사용)
- 모바일에서 스크롤 발생 원인 (이벤트 preventDefault 미호출)
- 데스크탑에서 이미지 드래그 발생 원인 (이미지 요소의 기본 동작)

**분석 방법**:
- 텍스트 렌더링 영역 계산: settings.left, settings.top, settings.fontSize 기반 박스 크기 결정
- 이벤트 핸들러 분석: 마우스 이벤트와 터치 이벤트의 차이점 파악
- 브라우저 기본 동작 분석: 드래그 중 발생하는 스크롤, 이미지 드래그 동작 확인

**예상 결과물**:
- 아웃라인 박스의 필요한 위치 및 크기 계산 방식
- 터치 이벤트 핸들러 추가 필요 항목 목록 (onTouchStart, onTouchMove, onTouchEnd)
- 차단해야 할 브라우저 기본 동작 목록 (touchmove 시 스크롤, dragstart 시 이미지 드래그)

### 3단계: 설계

**설계 영역**:
- 아웃라인 박스 컴포넌트 구조 (위치, 크기, 스타일)
- 통합 드래그 이벤트 핸들러 설계 (마우스 + 터치 지원)
- 브라우저 기본 동작 차단 로직

**설계 방법**:
- 아웃라인 박스: `settings.left`, `settings.top`을 기준으로 텍스트 영역을 표시하는 투명 박스 설계
  - 박스 크기: 폰트 크기 기반 계산 (예: 텍스트 길이 × fontSize 비율)
  - 박스 스타일: 점선 테두리, 호버 시 강조 표시
- 이벤트 핸들러: 마우스/터치 이벤트를 통합 처리하는 헬퍼 함수 설계
  - 드래그 시작: mousedown / touchstart
  - 드래그 이동: mousemove / touchmove
  - 드래그 종료: mouseup / touchend
- 기본 동작 차단: preventDefault() 호출 위치 결정
  - touchmove 이벤트에서 스크롤 방지
  - 이미지 요소에 dragstart 이벤트 차단

**설계 산출물**:
- 아웃라인 박스 렌더링 구조 (React JSX 구조)
- 통합 드래그 핸들러 함수 시그니처
- 이벤트 차단 전략

### 4단계: 구현

**구현 작업**:
- 작업 1: 드래그 핸들 제거 및 아웃라인 박스 렌더링 추가
  - 기존 드래그 핸들 (144-180번 줄) 제거
  - 텍스트 위치에 맞춰 아웃라인 박스 렌더링
  - 박스 크기는 `text.length * fontSize * 0.6` 정도로 가정 (대략적 너비)
- 작업 2: 터치 이벤트 핸들러 추가
  - `handleTouchStart`, `handleTouchMove`, `handleTouchEnd` 함수 구현
  - 기존 마우스 핸들러와 동일한 로직 적용 (좌표 추출 방식만 변경)
- 작업 3: 브라우저 기본 동작 차단
  - 아웃라인 박스에 `onTouchMove` 이벤트에서 `e.preventDefault()` 호출
  - 이미지 요소에 `onDragStart={(e) => e.preventDefault()}` 추가
  - 컨테이너 요소에 `touch-action: none` CSS 적용 (선택적)

**구현 순서**:
1. 아웃라인 박스 렌더링: 시각적 피드백을 먼저 구현하여 사용자 경험 개선
2. 터치 이벤트 추가: 모바일 지원을 위한 핵심 기능 구현
3. 기본 동작 차단: 드래그 동작이 정상 작동한 후 부작용 제거

**구현 방법**:
- 기존 코드 수정: `PreviewCanvasComponent.tsx` 파일 내에서 수정
- 드래그 핸들 제거: 144-180번 줄 삭제
- 아웃라인 박스 추가: 새로운 `<div>` 요소로 렌더링, 절대 위치 지정
- 터치 이벤트: 기존 마우스 이벤트 핸들러 패턴을 따라 구현

### 5단계: 검증

**검증 항목**:
- 아웃라인 박스 표시: 텍스트 위치에 정확히 박스가 표시되는지 확인
- 데스크탑 드래그: 마우스로 아웃라인 박스를 드래그하여 텍스트 위치 변경 가능 여부
- 모바일 드래그: 모바일 브라우저 또는 개발자 도구 터치 모드에서 드래그 동작 확인
- 스크롤 방지: 모바일에서 드래그 시 페이지가 스크롤되지 않는지 확인
- 이미지 드래그 방지: 데스크탑에서 드래그 시 배경 이미지가 이동하지 않는지 확인

**테스트 계획**:
- 데스크탑 브라우저에서 마우스 드래그 테스트
- Chrome 개발자 도구의 디바이스 에뮬레이션 모드로 터치 이벤트 테스트
- 실제 모바일 기기에서 테스트 (가능한 경우)

**완료 확인 방법**:
- 체크리스트 기반 확인:
  - [ ] 아웃라인 박스가 텍스트 위치에 표시됨
  - [ ] 마우스로 박스를 드래그하여 텍스트 이동 가능
  - [ ] 터치로 박스를 드래그하여 텍스트 이동 가능
  - [ ] 모바일 드래그 시 스크롤 발생하지 않음
  - [ ] 데스크탑 드래그 시 이미지가 이동하지 않음

## 기술적 고려사항

**사용 기술 스택**:
- React + TypeScript: 기존 프론트엔드 구조 유지
- 마우스 이벤트: `onMouseDown`, `onMouseMove`, `onMouseUp`
- 터치 이벤트: `onTouchStart`, `onTouchMove`, `onTouchEnd`

**기술적 제약 및 요구사항**:
- `CouponEmbeddingSettings` 인터페이스의 `left`, `top` 속성 활용
- 이미지 스케일링 고려: display 좌표와 실제 이미지 좌표 간 변환 필요

**기술 적용 방안**:
- 터치 이벤트 좌표 추출: `e.touches[0].clientX`, `e.touches[0].clientY` 사용
- 이벤트 통합: 마우스와 터치 이벤트를 별도 핸들러로 구현하되, 내부 로직은 공통 함수로 추출
- CSS `touch-action: none`: 필요시 아웃라인 박스에 적용하여 브라우저 제스처 차단

## 리스크 및 대응 방안

**식별된 리스크**:
- 아웃라인 박스 크기 계산 부정확: 텍스트 길이와 폰트 크기만으로는 정확한 텍스트 영역을 알 수 없음
- 터치 이벤트 충돌: 컨테이너와 아웃라인 박스에서 이벤트가 중복 발생할 가능성

**대응 전략**:
- 아웃라인 박스 크기 부정확: 초기에는 대략적 크기로 구현하고, 필요시 Canvas API나 SVG measureText 활용하여 정확한 크기 계산
- 터치 이벤트 충돌: `e.stopPropagation()`을 사용하여 이벤트 버블링 차단

## 완료 기준

**기능적 완료 기준**:
- 아웃라인 박스 표시: 프리뷰 이미지 위에 텍스트 위치에 맞춰 점선 또는 실선 테두리 박스가 표시됨
- 마우스 드래그: 박스를 마우스로 클릭하고 드래그하여 텍스트 위치를 변경할 수 있음
- 터치 드래그: 모바일 환경에서 박스를 터치하고 드래그하여 텍스트 위치를 변경할 수 있음
- 스크롤 방지: 모바일에서 박스를 드래그할 때 페이지 스크롤이 발생하지 않음
- 이미지 드래그 방지: 데스크탑에서 박스를 드래그할 때 배경 이미지가 이동하지 않음

**기술적 완료 기준**:
- `CouponEmbeddingSettings`의 `left`, `top` 속성을 사용하여 위치 업데이트
- 이미지 스케일링 고려: display 좌표를 실제 이미지 좌표로 정확히 변환
- React 상태 관리: `onSettingsChange` prop을 통해 부모 컴포넌트에 상태 전달

**품질 완료 기준**:
- 드래그 동작 일관성: 데스크탑과 모바일에서 동일한 사용자 경험 제공
- 시각적 피드백: 드래그 시작 시 박스 하이라이트, 드래그 중 커서 변경 등 명확한 피드백

## 단계별 의존성

### 순차 의존성

**필수 순차 진행**:
- 1단계 → 2단계: 현재 코드 구조를 파악해야 수정 대상과 영향 범위를 분석할 수 있음
- 2단계 → 3단계: 문제점과 요구사항을 분석한 후 구체적인 설계 방안을 도출할 수 있음
- 3단계 → 4단계: 설계가 완료된 후 실제 코드 구현 가능
- 4단계 → 5단계: 구현이 완료된 후 검증 수행 가능

**각 단계의 전제조건**:
- 2단계: 1단계에서 현재 드래그 시스템의 구조와 좌표 변환 로직 파악 완료
- 3단계: 2단계에서 아웃라인 박스 크기 계산 방식, 터치 이벤트 핸들러 목록, 차단할 브라우저 동작 목록 도출 완료
- 4단계: 3단계에서 아웃라인 박스 구조, 이벤트 핸들러 설계, 이벤트 차단 전략 완료
- 5단계: 4단계에서 아웃라인 박스 렌더링, 터치 이벤트 핸들러, 브라우저 기본 동작 차단 구현 완료

### 병렬 처리 가능 영역

- 4단계 내부 병렬 작업:
  - 작업 1 (아웃라인 박스 렌더링)과 작업 2 (터치 이벤트 핸들러)는 독립적으로 구현 가능
  - 작업 3 (기본 동작 차단)은 작업 1, 2 완료 후 테스트하며 추가하는 것이 효율적

### 단계 간 연결점

**연결점 정의**:
- 1단계 → 2단계:
  - 완료 조건: 현재 드래그 시스템의 구조와 좌표 변환 로직 파악 완료
  - 전달 산출물: 드래그 이벤트 핸들러 목록, 좌표 계산 방식, 드래그 핸들 렌더링 방식
- 2단계 → 3단계:
  - 완료 조건: 아웃라인 박스 크기 계산 방식, 터치 이벤트 핸들러 목록, 차단할 브라우저 동작 목록 도출
  - 전달 산출물: 텍스트 영역 계산 로직, 필요한 이벤트 핸들러 목록, 차단할 기본 동작 목록
- 3단계 → 4단계:
  - 완료 조건: 아웃라인 박스 구조, 이벤트 핸들러 시그니처, 이벤트 차단 전략 결정
  - 전달 산출물: 아웃라인 박스 JSX 구조, 통합 드래그 핸들러 설계, preventDefault 호출 위치
- 4단계 → 5단계:
  - 완료 조건: 아웃라인 박스 렌더링, 터치 이벤트 핸들러, 브라우저 기본 동작 차단 모두 구현 완료
  - 전달 산출물: 수정된 `PreviewCanvasComponent.tsx` 파일, 로컬 개발 서버 실행 가능 상태
