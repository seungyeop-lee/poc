include .env

# CloudFormation ë„¤ì´í‹°ë¸Œ ë°©ì‹ ë³€ìˆ˜
CLOUDFRONT_STACK_NAME=cloudfront-stack
SAM_STACK_NAME=poc-aws-lambda-web-adapter-nextjs

.PHONY: deploy-init
deploy-init:
	cp .env.example .env
	cp example.samconfig.toml samconfig.toml

.PHONY: build
build:
	sam build

.PHONY: local
local: build
	sam local start-api

.PHONY: deploy-cloudfront
deploy-cloudfront:
	@echo "ğŸš€ CloudFront ë°°í¬ ì‹œì‘..."
	aws cloudformation deploy \
		--template-file infrastructure/cloudfront.yaml \
		--stack-name $(CLOUDFRONT_STACK_NAME) \
		--parameter-overrides \
			AcmCertificateArnParameter="$(AcmCertificateArnParameter)" \
			CustomDomainName="$(CustomDomainName)" \
			OriginDomainName="example.com" \
		--capabilities CAPABILITY_IAM

.PHONY: deploy-sam
deploy-sam: build
	@echo "ğŸš€ SAM ë°°í¬ ì‹œì‘..."
	sam deploy --stack-name $(SAM_STACK_NAME) --no-confirm-changeset

.PHONY: update-cloudfront
update-cloudfront:
	@echo "ğŸš€ API Gateway ë„ë©”ì¸ í™•ì¸"
	$(eval API_GATEWAY_DOMAIN := $(shell aws cloudformation describe-stacks \
		--stack-name $(SAM_STACK_NAME) \
		--query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayDomainName`].OutputValue' \
		--output text))
	@echo "API Gateway Domain: $(API_GATEWAY_DOMAIN)"

	@if [ -z "$(API_GATEWAY_DOMAIN)" ]; then \
		echo "âŒ API Gateway ë„ë©”ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìŠ¤íƒì´ ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."; \
		exit 1; \
	fi
	
	@echo "ğŸš€ CloudFront origin ì—…ë°ì´íŠ¸"
	aws cloudformation deploy \
		--template-file infrastructure/cloudfront.yaml \
		--stack-name $(CLOUDFRONT_STACK_NAME) \
		--parameter-overrides \
			AcmCertificateArnParameter="$(AcmCertificateArnParameter)" \
			CustomDomainName="$(CustomDomainName)" \
			OriginDomainName="$(API_GATEWAY_DOMAIN)" \
		--capabilities CAPABILITY_IAM

# CloudFormation ë„¤ì´í‹°ë¸Œ ë°©ì‹ ë°°í¬ (í†µí•©)
.PHONY: deploy
deploy:
	@echo "ğŸš€ CloudFront + SAM í†µí•© ë°°í¬ ì‹œì‘..."
	
	$(MAKE) deploy-cloudfront
	$(MAKE) deploy-sam
	$(MAKE) update-cloudfront

	@echo "âœ… ë°°í¬ ì™„ë£Œ!"
	@echo "ğŸŒ CloudFront URL: https://$(CustomDomainName)"

.PHONY: delete-cloudfront
delete-cloudfront:
	@echo "ğŸ§¹ CloudFront ìŠ¤íƒ ì‚­ì œ ì‹œì‘..."
	aws cloudformation delete-stack --stack-name $(CLOUDFRONT_STACK_NAME)
	aws cloudformation wait stack-delete-complete --stack-name $(CLOUDFRONT_STACK_NAME)
	@echo "âœ… CloudFront ìŠ¤íƒ ì‚­ì œ ì™„ë£Œ!"

.PHONY: delete-sam
delete-sam:
	@echo "ğŸ§¹ SAM ìŠ¤íƒ ì‚­ì œ ì‹œì‘..."
	aws cloudformation delete-stack --stack-name $(SAM_STACK_NAME)
	aws cloudformation wait stack-delete-complete --stack-name $(SAM_STACK_NAME)
	@echo "âœ… SAM ìŠ¤íƒ ì‚­ì œ ì™„ë£Œ!"

# CloudFormation ë„¤ì´í‹°ë¸Œ ë°©ì‹ ì •ë¦¬
.PHONY: cleanup
cleanup:
	@echo "ğŸ§¹ CloudFront + SAM ìŠ¤íƒ ì •ë¦¬ ì‹œì‘..."

	$(MAKE) delete-cloudfront
	$(MAKE) delete-sam

	@echo "âœ… ì •ë¦¬ ì™„ë£Œ!"

# ë„ì›€ë§
.PHONY: help
help:
	@echo "ğŸ”§ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo "  make deploy-init    - ì´ˆê¸° ì„¤ì • íŒŒì¼ ìƒì„±"
	@echo "  make local          - ë¡œì»¬ ê°œë°œ ì„œë²„ ì‹¤í–‰"
	@echo "  make deploy         - CloudFront + SAM í†µí•© ë°°í¬"
	@echo "  make cleanup        - ëª¨ë“  ìŠ¤íƒ ì‚­ì œ"
	@echo "  make build          - SAM ë¹Œë“œë§Œ ì‹¤í–‰"
	@echo "  make help           - ì´ ë„ì›€ë§ í‘œì‹œ"
